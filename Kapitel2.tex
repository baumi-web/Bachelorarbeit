\chapter{Aufbau der Testumgebung}
\section{Physische und Virtuelle Komponenten}
\subsection{Test-Hardware}
\textbf{Hardware für OpnSense:}\\
Für die Open-Source-Lösung OPNsense wurde im Sinne eines praxisnahen Vergleichs zunächst versucht, eine sehr ressourcenschonende Hardware-Plattform zu verwenden. Die initiale Wahl fiel auf einen kompakten Embedded-PC vom Typ PC Engines APU4, der in der Open-Source-Community häufig für den Aufbau von Routern und Firewalls genutzt wird. Die Installation auf diesem ''headless'' System (ohne Grafikschnittstelle) erfolgte über das offizielle serielle Image von OPNsense. Hierfür wurde ein bootfähiger USB-Stick mit dem Programm Rufus erstellt und die gesamte Installation über eine serielle Konsole via PuTTY gesteuert.\\

Bereits während der initialen Konfiguration des Intrusion Prevention Systems Suricata zeigte sich jedoch, dass die Hardware mit 4 GB RAM und der schwachen CPU mit 1GHz an ihre Leistungsgrenzen stieß und acuh ohne Laden der Regel-Sets zu einer CPU-Auslastung von 100\% führte. Das Laden der ausgewählten Regel-Sets mit über 35.000 Signaturen führte schließlich zu Absturz der gesamten Umgebung. Dies stellt einen stabilen Testbetrieb in Frage.\\

Um eine valide und performante Testdurchführung zu gewährleisten und die Fähigkeiten der OPNsense-Software fair bewerten zu können, wurde daher eine Umstellung auf eine leistungsfähigere Hardware-Plattform vorgenommen. Als finales Testsystem für OPNsense dient nun ein NRG Systems Mini-PC, der mit einem Intel(R) Core(TM) i7-4510U Prozessor, 8 GB DDR3L RAM und vier Gigabit-LAN-Anschlüssen ausgestattet ist. Diese Hardware-Aufwertung unterstreicht einen fundamentalen Aspekt der Open-Source-Philosophie: die Flexibilität, die Hardware an die wachsenden Anforderungen anzupassen, aber auch die Notwendigkeit einer sorgfältigen initialen Dimensionierung. Die Installation auf diesem System erfolgte unkompliziert über das Standard-ISO-Abbild.\\

\textbf{Hardware für Virtualisierung:}\\
Als Virtualisierungs-Host, der die zu schützenden Client-Systeme im LAN-Segment beherbergt, dient ein kompakter Mini-PC vom Typ HP EliteDesk 800 G4 DM 35W. Das System ist mit einer Intel(R) Core(TM) i5-8500T CPU, mit einem 16 GB DDR4-Arbeitsspeicher ausgestattet. Als primärer Datenspeicher für die virtuellen Maschinen wurde eine 256 GB NVMe SSD gewählt.(siehe Abbildung~\ref{fig:hardware-prox})\\

Die Entscheidung für eine SSD anstelle einer mechanischen Festplatte (HDD) war für die Performance der Testumgebung entscheidend. In einer Virtualisierungsumgebung greifen mehrere VMs gleichzeitig auf den Speicher zu, was zu einer hohen Anzahl paralleler Lese- und Schreibvorgänge führt. Während eine HDD diese Anfragen aufgrund ihres mechanischen Aufbaus mit einem beweglichen Schreib-/Lesekopf nur sequenziell, also Schritt für Schritt, abarbeiten kann, ist eine SSD in der Lage, Tausende dieser Anfragen parallel zu bedienen. Dieser Vorteil verhindert einen Input/Output-Flaschenhals, der für die nachfolgenden Tests zu ungenauen Ergebnissen führen könnte.\\

\textbf{Angreifer-Systems (Kali Linux):}\\
Als Angreifer-System, das im ungesicherten WAN-Segment der Testumgebung agiert, wurde ein dedizierter Laptop vom Typ DELL Latitude 5520 verwendet. Das Gerät ist mit einem Intel(R) Core(TM) i7 Prozessor, 16 GB RAM und einer 500 GB SSD ausgestattet. Diese Hardware-Ressourcen wurden als mehr als ausreichend bewertet, um die für die Tests notwendigen Analyse- und Angriffswerkzeuge performant auszuführen.\\

Die Installation des Betriebssystems erfolgte mittels der offiziellen Installer ISO-Datei von Kali Linux (Version 2025.2). Um den Laptop von diesem Abbild zu starten, wurde mit dem Programm ''Rufus'' ein bootfähiger USB-Stick erstellt. Während des Installationsprozesses wurde die gesamte 500 GB SSD für Kali Linux partitioniert und ein Standardbenutzer für die Durchführung der Tests angelegt.\\

Ein entscheidender Schritt war die Netzwerkkonfiguration. Da sich der Angreifer-Laptop in einem isolierten, physischen Netzwerksegment (WAN\_KALI) befindet, das nur mit dem WAN-Port der zu testenden Firewall verbunden ist, musste eine statische IP-Konfiguration vorgenommen werden. Dies wurde über die Kommandozeilen-Schnittstelle \textit{nmcli} realisiert. Dem System wurde die IP-Adresse 192.168.107.40 /24 zugewiesen. Als Gateway wurde die IP-Adresse des WAN\_KALI-Interfaces der Firewall (192.168.107.1) eingetragen, um eine korrekte Routing-Beziehung herzustellen.\\

Nach der erfolgreichen Grundinstallation wurde das System zunächst auf den neuesten Stand gebracht. Hierfür wurden über das Terminal die Befehle \textit{sudo apt update} und \textit{sudo apt full-upgrade -y} ausgeführt. Um sicherzustellen, dass alle für die geplanten Tests notwendigen Werkzeuge zur Verfügung stehen, wurde anschließend das Metapackage kali-linux-default installiert. Dieser Befehl (\textit{sudo apt install -y kali-linux-default}) rüstet das System mit der Standard-Sammlung an Penetration-Testing-Tools aus, die unter anderem das Metasploit Framework, den Portscanner Nmap sowie den Paketgenerator hping3 umfasst.\\


\subsection{Virtualisierungssoftware}

Als Fundament für die Virtualisierung der Client-Systeme, die das LAN-Segment der Testumgebung abbilden, wurde die Open-Source-Plattform Proxmox Virtual Environment (VE) in der Version 8.2 gewählt. Die Entscheidung für einen dedizierten Bare-Metal-Hypervisor anstelle einer Desktop-Virtualisierungslösung wie VirtualBox wurde getroffen, um eine höhere Performance durch den direkten, ressourcenschonenden Zugriff auf die Hardware des Test-Laptops zu gewährleisten. Proxmox VE bot zudem die notwendige, granulare Kontrolle über die virtuelle Vernetzung und eine integrierte Snapshot-Funktionalität. Dieses Feature war für die Durchführung der Tests essenziell, da sie es ermöglicht, die Testsysteme vor jedem Testdurchlauf in einen definierten, sauberen Ausgangszustand zurückzusetzen und so für reproduzierbare Ergebnisse zu sorgen.\\

Die Installation erfolgte über das offizielle ISO-Abbild direkt auf dem dafür vorgesehenen Test-Laptop, der ausschließlich als Host für die Client-Systeme dient. Hierfür wurde zunächst ein bootfähiger USB-Stick erstellt. Der Installationsprozess selbst gestaltet sich unkompliziert, erforderte jedoch bei der Netzwerkkonfiguration einzelne manuelle Anpassungen. Da der Laptop als Server im LAN-Segment hinter der physischen Firewall agieren sollt, muss eine statische IP-Adresse, Subnetzmaske, Gateway (die LAN-IP-Adresse der Firewall), sowie der DNS-Server manuell in der Installationsroutine hinterlegt werden.\\

\textbf{Aufgetretenes Problem:}\\
Bei der Installation  traten initial Konnektivitätsprobleme auf. Anschließend war die webbasierte Verwaltungsoberfläche von einem anderen Rechner im Netzwerk nicht erreichbar, obwohl die Netzwerkinformationen im Installer korrekt eingegeben wurden. Eine Analyse über die Kommandozeile des Servers zeigte, dass die Netzwerkkonfigurationsdatei ''\textit{/etc/network/interfaces}'' nicht korrekt geschrieben wurde. Dieses Problem konnte durch eine manuelle Bearbeitung der Datei direkt auf der Server-Konsole und einen anschließenden Neustart des Netzwerk-Dienstes mittels ''\textit{systemctl restart networking.service}'' behoben werden. Erst danach war der Proxmox-Host unter der korrekten statischen IP-Adresse erreichbar und die weitere Konfiguration konnte über die Weboberfläche erfolgen.\\

Ein zentrales Konzept für den Aufbau der Testumgebung in Proxmox ist dabei die Verwendung von virtuellen Bridges. Für den in dieser Arbeit realisierten Aufbau wurde eine einzige virtuelle Bridge (vmbr0) konfiguriert, die direkt an die physische Netzwerkkarte des Proxmox-Laptops gekoppelt ist. Das physische LAN-Kabel verbindet diese Netzwerkkarte mit dem LAN-Port der zu testenden, physischen Firewall. Alle in Proxmox erstellten Client-VMs werden dann mit ihren virtuellen Netzwerkkarten an diese Bridge angeschlossen, wodurch sie zusammen ein virtuelles LAN-Segment bilden. Dieses Segment ist physisch direkt und ausschließlich mit einem geschützten LAN-Port der Firewall verbunden.\\


\subsection{Virtuelle Maschinen (VMs)}

Die Client-Systeme, die das geschützte LAN-Segment bilden, sowie ein interner Angreifer wurden vollständig innerhalb der Proxmox Virtual Environment virtualisiert. Der grundlegende Prozess zur Erstellung jeder VM umfasst das Hochladen der entsprechenden ISO-Abbilder in den lokalen Speicher des Proxmox-Hosts. Anschließend wurden die virtuellen Maschinen über den Installationsassistenten mit den für ihre jeweilige Rolle und ihr Betriebssystem passenden Hardwareressourcen konfiguriert.\\

\textbf{Ubuntu Desktop:}\\
Um repräsentative Linux-Clients im geschützten LAN abzubilden, wurden zwei identische VMs mit Ubuntu 24.04 LTS Desktop erstellt. Diese dienen als Ziele für Angriffe und zur Durchführung von Tests wie der Malware-Erkennung oder der Überprüfung von Filterregeln. Beiden VMs wurden jeweils 4 CPU-Kerne, 4 GiB Arbeitsspeicher und eine 50 GiB Festplatte zugewiesen. Um sie im geschützten LAN-Segment zu platzieren, wurden beide VMs mit ihren virtuellen Netzwerkkarten an die interne Bridge \textit{vmbr1} angebunden.(siehe Abbildung~\ref{fig:ubuntu-hardware})\\

\textbf{Kali-Linux:}\\
Zur Simulation eines internen Angriffs wurde eine VM mit Kali Linux aufgesetzt, die ein kompromittiertes Endgerät im LAN repräsentiert. Der VM wurden 4 CPU-Kerne, 4 GiB Arbeitsspeicher und eine 50 GiB Festplatte zugewiesen. Entscheidend für diesen Testfall wurde die Netzwerkkarte der VM, identisch zu den Client-Systemen, an die interne Bridge vmbr1 angebunden. (siehe Abbildung~\ref{fig:kali-hardware})\\
Dieser Aufbau eines flachen Netzwerks dient der praktischen Demonstration der Grenzen des reinen Perimeterschutzes. Wie erwartet, kann die physische Firewall den direkten Verkehr zwischen den VMs auf derselben Bridge nicht einsehen oder blockieren. Ein erfolgreicher interner Exploit demonstriert somit die kritische Schutzlücke, die bei alleiniger Konzentration auf den Perimeterschutz entsteht und unterstreicht die Notwendigkeit weiterführender Sicherheitskonzepte wie Zero-Trust und interner Netzwerksegmentierung.\\

\textbf{Windows 11:}\\
Zur Simulation einer typischen Workstation in einem Unternehmensumfeld wurde eine VM mit Microsoft Windows 11 Enterprise aufgesetzt. Entsprechend den höheren Anforderungen des Betriebssystems wurden dieser VM 4 CPU-Kerne, 8 GiB Arbeitsspeicher und eine 70 GiB Festplatte zugewiesen. Auch diese VM wurde an die Bridge \textit{vmbr1} angebunden, um sie im LAN zu positionieren.(siehe Abbildung~\ref{fig:win11-hardware})\\

\textbf{Besonderheit bei der Windows-Installation:}\\
Aufgrund der spezifischen Anforderungen von Windows 11 mussten in den Systemeinstellungen der VM das BIOS auf OVMF (UEFI) umgestellt und ein virtuelles Trusted Platform Module (TPM) 2.0 sowie eine EFI-Disk hinzugefügt werden.
 Im Gegensatz zu den Linux-basierten Systemen trat bei der Installation zudem ein Problem auf, da der Windows-Installer standardmäßig keine Treiber für die paravirtualisierte VirtIO-Hardware enthält. Dadurch konnte im Partitionierungs-Schritt der Installation keine Festplatte erkannt werden. Um dieses Problem zu lösen, musste die virtio-win.iso-Datei mit den Gast-Treibern heruntergeladen und der VM als zweites, virtuelles CD/DVD-Laufwerk zugewiesen werden. Im Windows-Setup konnten dann die Speichertreiber aus dem Verzeichnis \path{\viostor\w11\amd} manuell geladen werden, woraufhin die virtuelle Festplatte erkannt wurde und die Installation fortgesetzt und abgeschlossen werden konnte.

\section{Logische Netzwerkarchitektur}

Für die Durchführung der Tests wurde eine logische Netzwerkarchitektur entworfen, die eine realitätsnahe Topologie nachbildet. Das grundlegende Design basiert auf einer klaren Segmentierung in zwei separate Netzwerkzonen: ein unsicheres Wide Area Network (WAN), das das Internet simuliert, und ein durch eine Firewall geschütztes Local Area Network (LAN), das das interne Unternehmensnetzwerk darstellt. Die zu testende physische Firewall fungiert als zentraler Kopplungspunkt und einziges Gateway zwischen diesen beiden Zonen.\\

Das WAN-Segment wurde als Angriffsnetzwerk konzipiert. In diesem Netz befindet sich ausschließlich der dedizierte Angreifer-Laptop mit dem Betriebssystem Kali Linux. Diesem Netzwerk wurde der IP-Adressbereich 192.168.107.0/24 zugewiesen. Der WAN-Port der Firewall wurde mit einer statischen IP-Adresse aus diesem Bereich konfiguriert (192.168.107.1) und dient als Gateway für den Angreifer-PC.\\

Das LAN-Segment stellt die zu schützende Umgebung dar. Es besteht aus dem Proxmox-Server, dessen physische Netzwerkkarte direkt mit dem LAN-Port der Firewall verbunden ist. Alle für die Tests benötigten Client-Systeme (Windows 11, Ubuntu, Metasploitable) werden als virtuelle Maschinen innerhalb dieses Proxmox-Hosts betrieben. Dem LAN-Segment wurde der separate IP-Adressbereich 192.168.101.0/24 zugeteilt. Der LAN-Port der Firewall agiert hier als Standardgateway (192.168.101.1) für alle VMs und versorgt diese mittels eines auf der Firewall konfigurierten DHCP-Servers automatisch mit IP-Adressen.\\

Diese Architektur stellt sicher, dass jeder Angriffsversuch, der vom Kali-Linux-System im WAN ausgeht und auf einen der virtuellen Clients im LAN zielt, zwangsläufig die physische Firewall passieren muss. Der Datenverkehr wird am WAN-Port empfangen, von den Firewall-Richtlinien sowie der Intrusion-Prevention-Engine verarbeitet und erst dann, falls die Regeln es erlauben, an den LAN-Port und somit an das Zielsystem weitergeleitet. Dadurch ist die Firewall der einzige und obligatorische Inspektionspunkt für den gesamten relevanten Testverkehr, was die Grundvoraussetzung für einen validen Vergleich der beiden Systeme darstellt.

\section{Grundkonfiguration der IPS-Systeme}
\subsection{Konfiguration der FortiGate 70F}
\subsection{Konfiguration von OPNsense}

Die Konfiguration der OPNsense-Firewall wurde in zwei logischen Phasen durchgeführt. Zunächst wurde eine initiale Einrichtungsphase durchlaufen, in der dem System temporär ein Zugang zum Internet gewährt wurde. Dies war notwendig, um das Basissystem auf den neuesten Stand zu bringen, das für die Tests erforderliche Intrusion-Prevention-System-Plugin zu installieren und die benötigten Regel-Sets herunterzuladen. Nach Abschluss dieser Vorbereitungen wurde das System in die finale, isolierte Testkonfiguration überführt, in der es ausschließlich als Gateway zwischen dem Angreifer-Netz (WAN) und dem Client-Netz (LAN) fungiert.\\

\textbf{Konfiguration des IPS (Suricata):}\\
Die zentrale Schutzkomponente, das IPS, wurde durch die Installation des Plugins os-suricata über die Firmware-Verwaltung von OPNsense implementiert. Die anschließende Konfiguration des Dienstes erfolgte in mehreren Schritten. Zuerst wurden im Reiter ''Download'' die Regel-Sets ausgewählt und heruntergeladen.\\

Für die Konfiguration des Intrusion Prevention Systems wurde eine gezielte Auswahl an Regel-Sets getroffen, anstatt alle verfügbaren Regeln zu aktivieren. Dieser Ansatz verfolgt das Ziel, eine hohe Erkennungsrate für die relevanten Bedrohungsszenarien zu gewährleisten und gleichzeitig die Systemlast sowie das Risiko von Falschmeldungen (False-Positives) zu minimieren. Die Auswahl basiert hierbei auf einer mehrschichtigen Strategie.\\
Als Grundschutz dienen ausgewählte Kategorien des weit verbreiteten "ET Open"-Regel-Sets. Dabei wurden die Kategorien aktiviert, die direkt die in dieser Arbeit untersuchten Bedrohungen abdecken: Erkennung von Software-Ausnutzungen, Schadsoftware-Kommunikation, Denial-of-Service-Angriffen und Netzwerk-Scans. Ergänzt wurde diese Auswahl um die Kategorien ''attack\_response'' und ''compromised'', die Signaturen für bereits erfolgte Kompromittierungen enthalten.\\
Dieser breite, signaturbasierte Schutz wird durch spezialisierte, reputationsbasierte Bedrohungslisten des Non-Profit-Projekts abuse.ch ergänzt. Konkret wurden die ''SSL Fingerprint Blacklist'' und der ''ThreatFox''-Feed aktiviert. Diese Listen enthalten keine generischen Angriffsmuster, sondern blockieren aktiv die Kommunikation mit in Echtzeit identifizierten, bösartigen Command-and-Control-Servern.







Die Konfiguration der OPNsense-Firewall wurde in zwei logischen Phasen durchgeführt. Zunächst wurde eine initiale Einrichtungsphase durchlaufen, in der dem System temporär ein Zugang zum Internet gewährt wurde. Dies war notwendig, um das Basissystem auf den neuesten Stand zu bringen, das für die Tests erforderliche Intrusion-Prevention-System-Plugin zu installieren und die benötigten Regel-Sets herunterzuladen. Nach Abschluss dieser Vorbereitungen wurde das System in die finale, isolierte Testkonfiguration überführt.\\

Die Konfiguration der Netzwerkschnittstellen erfolgte gemäß der in Kapitel 3.2 definierten logischen Netzwerkarchitektur. Der LAN-Schnittstelle wurde ihre Rolle als Gateway für das interne Netz zugewiesen und unter Services > DHCPv4 > [LAN] mit einem DHCP-Server zur automatischen Adressvergabe an die Client-VMs ausgestattet. Die WAN\_KALI-Schnittstelle wurde als statischer Endpunkt für das Angreifer-Netz konfiguriert, wobei die systemeigenen Filter ''Block private networks'' und ''Block bogon networks'' für diese Schnittstelle bewusst deaktiviert wurden, da der angeschlossene Angreifer eine private IP-Adresse verwendet.\\

\textbf{Konfiguration des IPS (Suricata):}\\
Die zentrale Schutzkomponente, das IPS, wurde durch die Installation des Plugins os-suricata implementiert. Nach der Auswahl und dem Download der Regel-Sets ''ET Open'' und ''abuse.ch'' wurde der Dienst im Reiter ''Settings'' global aktiviert, in den "Inline Mode" (IPS) versetzt und angewiesen, den Verkehr auf der WAN\_KALI-Schnittstelle zu überwachen. Um die Signaturen scharfzuschalten, wurde im Reiter "Policy" eine übergeordnete Richtlinie erstellt, die alle heruntergeladenen Regel-Sets anwies, bei einem Treffer die Standard-Aktion drop (aktiv blockieren) auszuführen.\\

Zuletzt wurden die Firewall-Regeln unter Firewall > Rules erstellt. Da OPNsense einer ''Default Deny''-Strategie folgt, bei der jeglicher Verkehr, der nicht explizit erlaubt ist, blockiert wird, mussten spezifische Regeln erstellt werden, um den für die Tests notwendigen Datenfluss zu ermöglichen.\\
Für den eingehenden Testverkehr wurde auf dem WAN\_KALI-Interface eine Regel angelegt, die den gezielten Angriff vom Kali-Laptop auf die zu testenden Dienste der Client-VMs erlaubt. Der Zweck dieser Regel ist es, den Angriffsverkehr kontrolliert an die IPS-Engine weiterzuleiten, die auf diesem Interface den Verkehr analysiert.\\

Für den ausgehenden Verkehr vom LAN ins WAN wurde aus Gründen der Vereinfachung im Testlabor eine "Pass-All"-Regel erstellt, die dem gesamten LAN net den Zugriff auf jedes beliebige Ziel erlaubt.\\

\textbf{Hinweis:}
Es ist wichtig zu betonen, dass dies keine ''Best-Practice''-Konfiguration für eine produktive Umgebung darstellt. In einem realen Unternehmensnetzwerk würde an dieser Stelle ein wesentlich restriktiveres Regelwerk nach dem Prinzip der geringsten Rechte zum Einsatz kommen. Dabei würden typischerweise Adress-Objekte oder Gruppen (z.B. ''Buchhaltung'', ''Entwicklung'', ''Administration'', Drucker'') erstellt werden. Anschließend würden für jede dieser Gruppen granulare Regeln definiert, die nur den Zugriff auf die für ihre Arbeit absolut notwendigen Dienste und Ports erlauben (z.B. nur HTTP und HTTPS für Standard-Nutzer). Alle anderen ausgehenden Verbindungen würden durch die implizite ''Deny-All''-Regel am Ende des Regelwerks blockiert. Für die klar definierte Testumgebung dieser Arbeit wurde auf diese granulare Aufteilung verzichtet, um den Fokus auf die Inbound-IPS-Funktionalität zu legen.